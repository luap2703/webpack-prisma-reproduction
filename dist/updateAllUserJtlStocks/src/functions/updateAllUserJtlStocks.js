(()=>{"use strict";var e={614:(e,t,r)=>{r.r(t);const a=require("@prisma/client"),n=require("prisma-nested-middleware"),i=require("rollbar");var o=new(r.n(i)())({accessToken:"5362515d503c4bea9ef92fd528d54fb2",captureUncaught:!0,environment:"production",captureUnhandledRejections:!0,verbose:!0});const s=require("@aws-sdk/client-s3"),c=require("@aws-sdk/s3-request-presigner"),d={credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY},region:"eu-central-1"},l=new s.S3Client(d),getSignedDownloadUrl=async(e,t=86400)=>{try{let r=new Date;r.setUTCHours(0,0,0,0),r.setUTCDate(r.getUTCDate());const a=new s.GetObjectCommand({Bucket:process.env.AWS_S3_BUCKET_NAME,Key:e});return await(0,c.getSignedUrl)(l,a,{expiresIn:t,signingDate:r})}catch(e){throw o.error(e),new Error("Couldn't create download url")}},u=new a.PrismaClient;u.$use((0,n.createNestedMiddleware)((async(e,t)=>{const r=await t(e);if("File"==e.model&&r)if("delete"==e.action)r.file_id&&r.file_type&&await(async(e,t)=>{try{const r=new s.DeleteObjectCommand({Bucket:process.env.AWS_S3_BUCKET_NAME,Key:`USER_MEDIA/${t}/${e}`});return await l.send(r)}catch(e){throw o.error(e),new Error("Couldn't delete file, please try again later")}})(r.file_id,r.file_type);else if("deleteMany"==e.action)throw new Error("Delete many on files is not allowed! - Delete one by one");return r}))),u.$use((0,n.createNestedMiddleware)((async(e,t)=>{const r=await t(e);try{if("File"==e.model&&"delete"!=e.action&&"deleteMany"!=e.action&&"createMany"!=e.action&&"create"!=e.action&&"updateMany"!=e.action&&"aggregate"!=e.action&&"disconnect"!=e.action&&"connect"!=e.action&&"count"!=e.action&&r){if(Array.isArray(r)){return await Promise.all(r.map((async e=>{const t=await getSignedDownloadUrl(`USER_MEDIA/${e.file_type}/${e.file_id}`);return{...e,url:t}})))}{const e=await getSignedDownloadUrl(`USER_MEDIA/${r.file_type}/${r.file_id}`);return{...r,url:e}}}}catch(e){o.info(e)}return r}))),u.$use((0,n.createNestedMiddleware)((async(e,t)=>{const r=await t(e);try{if("File"==e.model&&"create"==e.action&&r){const e=await(async(e,t,r)=>{try{const a=new s.PutObjectCommand({Bucket:process.env.AWS_S3_BUCKET_NAME,Key:`USER_MEDIA/${t}/${e}`});return await(0,c.getSignedUrl)(l,a,{expiresIn:r})}catch(e){throw o.error(e),new Error("Couldn't get signed upload url")}})(r.file_id,r.file_type,3600);return{...r,url:e}}}catch(e){o.error(e)}return r}))),u.$use((0,n.createNestedMiddleware)((async(e,t)=>{const r=await t(e);try{if("UserOnChat"==e.model&&"findMany"==e.action&&!e.scope?.parentParams?.model&&r){return await u.$transaction((async e=>{const t=r.map((async t=>{const r=await e.message.count({where:{chat_id:t.chat_id,user_id:{not:t.user_id},created_at:{gt:t.last_seen_at},parent_id:null}});return{...t,unread_messages_count:r}}));return await Promise.all(t)}))}}catch(e){o.error(e)}return r})));const _=u.$extends({result:{user:{name:{needs:{given_name:!0,family_name:!0},compute:e=>`${e.given_name} ${e.family_name}`}}}}).$extends({result:{amazonProduct:{isReady:{needs:{unitsShippedT1:!0,unitsShippedT3:!0,unitsShippedT7:!0,unitsShippedT30:!0,total_quantity:!0,products_per_carton:!0,sales_velocity:!0},compute:e=>null!=e.unitsShippedT1&&null!=e.unitsShippedT3&&null!=e.unitsShippedT7&&null!=e.unitsShippedT30&&null!=e.total_quantity}}}}),p=require("aws-sdk");(e=r.hmd(e)).exports.handler=async()=>{try{const e=await _.apiConnection.findMany({where:{api_provider:a.ApiProvider.JTL_FULFILLMENT,outdated:!1}});return console.log("Updating JTL stocks for",e.length,"accounts:",e.map((e=>e.company_id))),await Promise.all(e.map((async e=>{const t=new p.Lambda,r={FunctionName:"updateUserJtlStocks",InvocationType:"DryRun",Payload:JSON.stringify({company_id:e.company_id})},a=await t.invoke(r).promise();console.log(a.StatusCode)}))),{statusCode:200,message:"Successfully updated all JTL stocks"}}catch(e){return o.error(e),Promise.reject(e)}}}},t={};function __webpack_require__(r){var a=t[r];if(void 0!==a)return a.exports;var n=t[r]={id:r,loaded:!1,exports:{}};return e[r](n,n.exports,__webpack_require__),n.loaded=!0,n.exports}__webpack_require__.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return __webpack_require__.d(t,{a:t}),t},__webpack_require__.d=(e,t)=>{for(var r in t)__webpack_require__.o(t,r)&&!__webpack_require__.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},__webpack_require__.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r=__webpack_require__(614),a=exports;for(var n in r)a[n]=r[n];r.__esModule&&Object.defineProperty(a,"__esModule",{value:!0})})();